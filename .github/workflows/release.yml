name: Release

on:
  push:
    tags:
      - "v*"

env:
  BUILD_TYPE: Release
  TDLIB_COMMIT: "5742c287cd514e7a1ee7908d63b4e5fca8638799"

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Install wxWidgets - try different package names for compatibility
          sudo apt-get install -y libwxgtk3.2-dev libwxgtk-webview3.2-dev 2>/dev/null || \
            sudo apt-get install -y libwxgtk3.0-gtk3-dev libwxgtk-webview3.0-gtk3-dev 2>/dev/null || \
            sudo apt-get install -y libwxgtk3.0-dev
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            zlib1g-dev \
            libwebp-dev \
            libavformat-dev \
            libavcodec-dev \
            libswscale-dev \
            libswresample-dev \
            libavutil-dev \
            libsdl2-dev \
            librlottie-dev \
            gperf \
            libgtk-3-dev

      - name: Cache TDLib
        id: cache-tdlib
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-linux-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-linux-${{ env.TDLIB_COMMIT }}-
            tdlib-linux-

      - name: Build TDLib
        if: steps.cache-tdlib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local ..
          cmake --build . --target install -j$(nproc)

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          tar -czvf ../teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-linux-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          brew install \
            cmake \
            wxwidgets \
            openssl \
            zlib \
            webp \
            ffmpeg \
            sdl2 \
            gperf

      - name: Cache TDLib
        id: cache-tdlib-macos
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-macos-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-macos-${{ env.TDLIB_COMMIT }}-
            tdlib-macos-

      - name: Build TDLib
        if: steps.cache-tdlib-macos.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) ..
          cmake --build . --target install -j$(sysctl -n hw.ncpu)

      - name: Cache rlottie
        id: cache-rlottie
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/librlottie*
            /usr/local/include/rlottie*
            /usr/local/lib/cmake/rlottie
            /usr/local/lib/pkgconfig/rlottie.pc
          key: rlottie-macos-${{ runner.arch }}-v3
          restore-keys: |
            rlottie-macos-${{ runner.arch }}-
            rlottie-macos-

      - name: Build rlottie from source
        if: steps.cache-rlottie.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/Samsung/rlottie.git
          cd rlottie
          # Disable examples to avoid linking issues
          grep -v "add_subdirectory(example)" CMakeLists.txt > CMakeLists.txt.new
          mv CMakeLists.txt.new CMakeLists.txt
          # Remove the NEON source file entirely to avoid pixman assembly symbol issues on ARM64 macOS
          # The vdrawhelper_neon.cpp file references external pixman asm symbols that aren't available
          sed -i '' 's|"${CMAKE_CURRENT_LIST_DIR}/vdrawhelper_neon.cpp"||' src/vector/CMakeLists.txt
          # Patch vdrawhelper.cpp to always use fallback memfill32 on ARM64 macOS
          # The original condition is: #if !defined(__SSE2__) && !defined(__ARM_NEON__)
          # We change it to always enable the fallback by removing the ARM_NEON check
          sed -i '' 's/#if !defined(__SSE2__) && !defined(__ARM_NEON__)/#if !defined(__SSE2__)/' src/vector/vdrawhelper.cpp
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DLIB_INSTALL_DIR=/usr/local/lib \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DLOTTIE_MODULE=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            ..
          make -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
            -DTDLIB_ROOT=$HOME/.local

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          tar -czvf ../teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-macos-arm64
          path: teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz

  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-wxwidgets3.2-msw
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-libwebp
            mingw-w64-x86_64-ffmpeg
            mingw-w64-x86_64-SDL2
            mingw-w64-x86_64-rlottie
            mingw-w64-x86_64-tdlib

      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Configure CMake
        run: |
          cmake -B build -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter.exe release/
          # Copy required DLLs
          ldd build/teleliter.exe | grep mingw64 | awk '{print $3}' | xargs -I{} cp {} release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          7z a ../teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-windows-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip

  create-release:
    needs: [build-ubuntu, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Teleliter v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
