name: Release

on:
  push:
    tags:
      - "v*"

env:
  BUILD_TYPE: Release
  TDLIB_COMMIT: "5742c287cd514e7a1ee7908d63b4e5fca8638799"

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Install wxWidgets - check what's available and install
          if apt-cache show libwxgtk3.2-dev >/dev/null 2>&1; then
            sudo apt-get install -y libwxgtk3.2-dev libwxgtk-media3.2-dev
          elif apt-cache show libwxgtk3.0-gtk3-dev >/dev/null 2>&1; then
            sudo apt-get install -y libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev
          else
            sudo apt-get install -y libwxgtk3.0-dev
          fi
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            zlib1g-dev \
            libwebp-dev \
            libavformat-dev \
            libavcodec-dev \
            libswscale-dev \
            libswresample-dev \
            libavutil-dev \
            libsdl2-dev \
            librlottie-dev \
            gperf \
            libgtk-3-dev

      - name: Cache TDLib
        id: cache-tdlib
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-linux-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-linux-${{ env.TDLIB_COMMIT }}-
            tdlib-linux-

      - name: Build TDLib
        if: steps.cache-tdlib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local ..
          cmake --build . --target install -j$(nproc)

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          tar -czvf ../teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-linux-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          brew install \
            cmake \
            wxwidgets \
            openssl \
            zlib \
            webp \
            ffmpeg \
            sdl2 \
            gperf

      - name: Cache TDLib
        id: cache-tdlib-macos
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-macos-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-macos-${{ env.TDLIB_COMMIT }}-
            tdlib-macos-

      - name: Build TDLib
        if: steps.cache-tdlib-macos.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) ..
          cmake --build . --target install -j$(sysctl -n hw.ncpu)

      - name: Cache rlottie
        id: cache-rlottie
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/librlottie*
            /usr/local/include/rlottie*
            /usr/local/lib/cmake/rlottie
            /usr/local/lib/pkgconfig/rlottie.pc
          key: rlottie-macos-${{ runner.arch }}-v4
          restore-keys: |
            rlottie-macos-${{ runner.arch }}-
            rlottie-macos-

      - name: Build rlottie from source
        if: steps.cache-rlottie.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/Samsung/rlottie.git
          cd rlottie
          # Disable examples to avoid linking issues
          grep -v "add_subdirectory(example)" CMakeLists.txt > CMakeLists.txt.new
          mv CMakeLists.txt.new CMakeLists.txt
          # Remove the NEON source file entirely to avoid pixman assembly symbol issues on ARM64 macOS
          # The vdrawhelper_neon.cpp file references external pixman asm symbols that aren't available
          sed -i '' 's|"${CMAKE_CURRENT_LIST_DIR}/vdrawhelper_neon.cpp"||' src/vector/CMakeLists.txt
          # Patch vdrawhelper.cpp to always use fallback memfill32 on ARM64 macOS
          # The original condition is: #if !defined(__SSE2__) && !defined(__ARM_NEON__)
          # We change it to always enable the fallback by removing the ARM_NEON check
          sed -i '' 's/#if !defined(__SSE2__) && !defined(__ARM_NEON__)/#if !defined(__SSE2__)/' src/vector/vdrawhelper.cpp
          # Patch vdrawhelper_common.cpp to not call neon() on ARM64 macOS
          # Remove the #if defined(__ARM_NEON__) block that calls neon()
          sed -i '' 's/#if defined(__ARM_NEON__)/\#if 0 \&\& defined(__ARM_NEON__)/' src/vector/vdrawhelper_common.cpp
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DLIB_INSTALL_DIR=/usr/local/lib \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DLOTTIE_MODULE=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            ..
          make -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
            -DTDLIB_ROOT=$HOME/.local

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          tar -czvf ../teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-macos-arm64
          path: teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz

  build-windows:
    runs-on: windows-latest

    env:
      VCPKG_DEFAULT_BINARY_CACHE: C:\vcpkg_cache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        shell: bash
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Create vcpkg binary cache directory
        run: |
          if (!(Test-Path "$env:VCPKG_DEFAULT_BINARY_CACHE")) {
            New-Item -ItemType Directory -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" -Force
          }

      - name: Cache vcpkg binary cache
        id: cache-vcpkg-binary
        uses: actions/cache@v4
        with:
          path: C:\vcpkg_cache
          key: vcpkg-binary-windows-x64-v2-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            vcpkg-binary-windows-x64-v2-

      - name: Cache vcpkg installed packages
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: vcpkg-installed-windows-x64-v2-${{ hashFiles('.github/workflows/release.yml') }}

      - name: Setup vcpkg
        run: |
          if (!(Test-Path "C:\vcpkg\.git")) {
            Remove-Item -Recurse -Force "C:\vcpkg" -ErrorAction SilentlyContinue
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          }
          C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          echo "C:\vcpkg" >> $env:GITHUB_PATH

      - name: Install dependencies via vcpkg
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          C:\vcpkg\vcpkg install --triplet=x64-windows `
            wxwidgets `
            openssl `
            zlib `
            libwebp `
            ffmpeg `
            sdl2 `
            rlottie `
            gperf

      - name: Cache TDLib
        id: cache-tdlib-windows
        uses: actions/cache@v4
        with:
          path: C:\tdlib
          key: tdlib-windows-${{ env.TDLIB_COMMIT }}-x64-v2
          restore-keys: |
            tdlib-windows-${{ env.TDLIB_COMMIT }}-x64-v2

      - name: Build TDLib
        if: steps.cache-tdlib-windows.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout %TDLIB_COMMIT%
          mkdir build
          cd build
          cmake -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_INSTALL_PREFIX=C:/tdlib -DGPERF_EXECUTABLE=C:/vcpkg/installed/x64-windows/tools/gperf/gperf.exe ..
          cmake --build . --target install --config Release -j %NUMBER_OF_PROCESSORS%

      - name: Configure CMake
        run: |
          cmake -B build -A x64 `
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DTDLIB_ROOT=C:/tdlib

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j $env:NUMBER_OF_PROCESSORS

      - name: Package
        shell: bash
        run: |
          mkdir -p release
          cp build/Release/teleliter.exe release/
          # Copy required DLLs from vcpkg
          cp C:/vcpkg/installed/x64-windows/bin/*.dll release/ 2>/dev/null || true
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          7z a ../teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-windows-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip

  create-release:
    needs: [build-ubuntu, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Teleliter v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
