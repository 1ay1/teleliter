name: Release

on:
  push:
    tags:
      - "v*"

env:
  BUILD_TYPE: Release
  TDLIB_COMMIT: "5742c287cd514e7a1ee7908d63b4e5fca8638799"

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Install wxWidgets - check what's available and install
          if apt-cache show libwxgtk3.2-dev >/dev/null 2>&1; then
            sudo apt-get install -y libwxgtk3.2-dev libwxgtk-media3.2-dev
          elif apt-cache show libwxgtk3.0-gtk3-dev >/dev/null 2>&1; then
            sudo apt-get install -y libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev
          else
            sudo apt-get install -y libwxgtk3.0-dev
          fi
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            zlib1g-dev \
            libwebp-dev \
            libavformat-dev \
            libavcodec-dev \
            libswscale-dev \
            libswresample-dev \
            libavutil-dev \
            libsdl2-dev \
            librlottie-dev \
            gperf \
            libgtk-3-dev \
            libfuse2 \
            file

      - name: Cache TDLib
        id: cache-tdlib
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-linux-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-linux-${{ env.TDLIB_COMMIT }}-
            tdlib-linux-

      - name: Build TDLib
        if: steps.cache-tdlib.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local ..
          cmake --build . --target install -j$(nproc)

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp build/teleliter AppDir/usr/bin/

          # Create desktop file
          cat > AppDir/usr/share/applications/teleliter.desktop << 'EOF'
          [Desktop Entry]
          Name=Teleliter
          Exec=teleliter
          Icon=teleliter
          Type=Application
          Categories=Network;Chat;
          Comment=Telegram client
          EOF

          # Create a simple icon using ImageMagick or Python
          sudo apt-get install -y imagemagick || true
          convert -size 256x256 xc:'#4682B4' -fill white -gravity center -pointsize 72 -annotate 0 'TL' AppDir/usr/share/icons/hicolor/256x256/apps/teleliter.png || \
            python3 -c "
          from PIL import Image, ImageDraw
          img = Image.new('RGB', (256, 256), '#4682B4')
          draw = ImageDraw.Draw(img)
          draw.text((80, 80), 'TL', fill='white')
          img.save('AppDir/usr/share/icons/hicolor/256x256/apps/teleliter.png')
          " || \
            # Fallback: download a valid placeholder PNG
            wget -q -O AppDir/usr/share/icons/hicolor/256x256/apps/teleliter.png "https://raw.githubusercontent.com/nicehash/NiceHashMiner/master/src/NiceHashMiner/Resources/icon.png" || \
            # Last resort: create minimal valid PNG with printf
            printf '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x01\x00\x00\x00\x01\x00\x08\x02\x00\x00\x00\xd3\x10?1\x00\x00\x00\x12IDATx\x9cc\xfc\xcf\xc0\xf0\x9f\x81\x81\x81\x81\x81\x81\x01\x00\x05\x04\x01\x01\xb2\xce\xf7\xf1\x00\x00\x00\x00IEND\xaeB`\x82' > AppDir/usr/share/icons/hicolor/256x256/apps/teleliter.png

          # Create AppImage with bundled libraries
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            --desktop-file AppDir/usr/share/applications/teleliter.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/teleliter.png

          # Rename AppImage
          mv Teleliter*.AppImage teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-linux-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-linux-x86_64.AppImage

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          brew install \
            cmake \
            wxwidgets \
            openssl \
            zlib \
            webp \
            ffmpeg \
            sdl2 \
            gperf

      - name: Cache TDLib
        id: cache-tdlib-macos
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: tdlib-macos-${{ env.TDLIB_COMMIT }}-${{ runner.arch }}
          restore-keys: |
            tdlib-macos-${{ env.TDLIB_COMMIT }}-
            tdlib-macos-

      - name: Build TDLib
        if: steps.cache-tdlib-macos.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout ${{ env.TDLIB_COMMIT }}
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/.local -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) ..
          cmake --build . --target install -j$(sysctl -n hw.ncpu)

      - name: Cache rlottie
        id: cache-rlottie
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/librlottie*
            /usr/local/include/rlottie*
            /usr/local/lib/cmake/rlottie
            /usr/local/lib/pkgconfig/rlottie.pc
          key: rlottie-macos-${{ runner.arch }}-v4
          restore-keys: |
            rlottie-macos-${{ runner.arch }}-
            rlottie-macos-

      - name: Build rlottie from source
        if: steps.cache-rlottie.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/Samsung/rlottie.git
          cd rlottie
          # Disable examples to avoid linking issues
          grep -v "add_subdirectory(example)" CMakeLists.txt > CMakeLists.txt.new
          mv CMakeLists.txt.new CMakeLists.txt
          # Remove the NEON source file entirely to avoid pixman assembly symbol issues on ARM64 macOS
          # The vdrawhelper_neon.cpp file references external pixman asm symbols that aren't available
          sed -i '' 's|"${CMAKE_CURRENT_LIST_DIR}/vdrawhelper_neon.cpp"||' src/vector/CMakeLists.txt
          # Patch vdrawhelper.cpp to always use fallback memfill32 on ARM64 macOS
          # The original condition is: #if !defined(__SSE2__) && !defined(__ARM_NEON__)
          # We change it to always enable the fallback by removing the ARM_NEON check
          sed -i '' 's/#if !defined(__SSE2__) && !defined(__ARM_NEON__)/#if !defined(__SSE2__)/' src/vector/vdrawhelper.cpp
          # Patch vdrawhelper_common.cpp to not call neon() on ARM64 macOS
          # Remove the #if defined(__ARM_NEON__) block that calls neon()
          sed -i '' 's/#if defined(__ARM_NEON__)/\#if 0 \&\& defined(__ARM_NEON__)/' src/vector/vdrawhelper_common.cpp
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DLIB_INSTALL_DIR=/usr/local/lib \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DLOTTIE_MODULE=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            ..
          make -j$(sysctl -n hw.ncpu)
          sudo make install

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl) \
            -DTDLIB_ROOT=$HOME/.local

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          mkdir -p release
          cp build/teleliter release/
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          tar -czvf ../teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-macos-arm64
          path: teleliter-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz

  build-windows:
    runs-on: windows-latest

    env:
      VCPKG_DEFAULT_BINARY_CACHE: C:\vcpkg_cache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        shell: bash
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Create vcpkg binary cache directory
        run: |
          if (!(Test-Path "$env:VCPKG_DEFAULT_BINARY_CACHE")) {
            New-Item -ItemType Directory -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" -Force
          }

      - name: Cache vcpkg binary cache
        id: cache-vcpkg-binary
        uses: actions/cache@v4
        with:
          path: C:\vcpkg_cache
          key: vcpkg-binary-windows-x64-v3-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            vcpkg-binary-windows-x64-v3-

      - name: Cache vcpkg installed packages
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg\installed
          key: vcpkg-installed-windows-x64-v3-${{ hashFiles('.github/workflows/release.yml') }}

      - name: Setup vcpkg
        run: |
          if (!(Test-Path "C:\vcpkg\.git")) {
            Remove-Item -Recurse -Force "C:\vcpkg" -ErrorAction SilentlyContinue
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          }
          C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          echo "C:\vcpkg" >> $env:GITHUB_PATH
          # Create release-only triplet to skip debug builds
          $tripletContent = @"
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE dynamic)
          set(VCPKG_LIBRARY_LINKAGE dynamic)
          set(VCPKG_BUILD_TYPE release)
          "@
          $tripletContent | Out-File -FilePath "C:\vcpkg\triplets\x64-windows-release.cmake" -Encoding UTF8

      - name: Install dependencies via vcpkg
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          # Retry logic for flaky network
          $maxRetries = 3
          $retryCount = 0
          $success = $false
          while (-not $success -and $retryCount -lt $maxRetries) {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries"
            C:\vcpkg\vcpkg install --triplet=x64-windows-release `
              wxwidgets `
              openssl `
              zlib `
              libwebp `
              ffmpeg[core,avcodec,avformat,swscale,swresample] `
              sdl2 `
              rlottie `
              gperf
            if ($LASTEXITCODE -eq 0) {
              $success = $true
            } else {
              Write-Host "vcpkg install failed, retrying in 30 seconds..."
              Start-Sleep -Seconds 30
            }
          }
          if (-not $success) {
            Write-Host "vcpkg install failed after $maxRetries attempts"
            exit 1
          }

      - name: Cache TDLib
        id: cache-tdlib-windows
        uses: actions/cache@v4
        with:
          path: C:\tdlib
          key: tdlib-windows-${{ env.TDLIB_COMMIT }}-x64-v3
          restore-keys: |
            tdlib-windows-${{ env.TDLIB_COMMIT }}-x64-v3

      - name: Build TDLib
        if: steps.cache-tdlib-windows.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          git clone https://github.com/tdlib/td.git
          cd td
          git checkout %TDLIB_COMMIT%
          mkdir build
          cd build
          cmake -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-release -DCMAKE_INSTALL_PREFIX=C:/tdlib -DGPERF_EXECUTABLE=C:/vcpkg/installed/x64-windows-release/tools/gperf/gperf.exe ..
          cmake --build . --target install --config Release -j %NUMBER_OF_PROCESSORS%

      - name: Configure CMake
        run: |
          cmake -B build -A x64 `
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows-release `
            -DTDLIB_ROOT=C:/tdlib

      - name: Build
        run: cmake --build build --config ${{env.BUILD_TYPE}} -j $env:NUMBER_OF_PROCESSORS

      - name: Package
        shell: bash
        run: |
          mkdir -p release
          cp build/Release/teleliter.exe release/
          # Copy required DLLs from vcpkg
          cp C:/vcpkg/installed/x64-windows-release/bin/*.dll release/ 2>/dev/null || true
          cp VERSION release/
          cp -r doc release/ 2>/dev/null || true
          cd release
          7z a ../teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleliter-windows-x86_64
          path: teleliter-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip

  create-release:
    needs: [build-ubuntu, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Teleliter v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
